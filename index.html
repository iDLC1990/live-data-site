<script>
  const sheetID = '10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU';
  const sheetName = 'live data';
  const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(sheetName)}`;

  function excelDateToJSDate(serial) {
    const utc_days = Math.floor(serial - 25569);
    const date = new Date(utc_days * 86400 * 1000);
    return date.toLocaleDateString('ru-RU', { day: 'numeric', month: 'long', year: 'numeric' });
  }

  fetch(url)
    .then(res => res.text())
    .then(rep => {
      const data = JSON.parse(rep.substr(47).slice(0, -2));
      const headers = data.table.cols.map(c => c.label).slice(2);
      const rows = data.table.rows.map(r => r.c.map(c => c ? c.v : ''));

      let section = null;
      const fi1Rows = [];
      const fi2Rows = [];

      rows.forEach(row => {
        const marker = row[1];       // второй столбец
        const trimmed = row.slice(2) // обрезаем первые два
          .map(cell => (typeof cell === 'number' && cell > 40000)
                        ? excelDateToJSDate(cell)
                        : cell || '');

        if (marker === 'FI #1') {
          section = 'fi1';
          return;
        }
        if (marker === 'FI #2') {
          section = 'fi2';
          return;
        }
        // пропускаем эти строки:
        if (marker === 'COUNTA z Status' || marker === 'Name') return;

        if (section === 'fi1') {
          fi1Rows.push(trimmed);
        } else if (section === 'fi2') {
          fi2Rows.push(trimmed);
        }
      });

      // Инициализируем DataTables
      $('#table-fi1').DataTable({
        data: fi1Rows,
        columns: headers.map(h => ({ title: h })),
        paging: false, searching: false, info: false
      });
      $('#table-fi2').DataTable({
        data: fi2Rows,
        columns: headers.map(h => ({ title: h })),
        paging: false, searching: false, info: false
      });
    })
    .catch(err => console.error('Ошибка загрузки данных:', err));
</script>
