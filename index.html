<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>LCDR LIVE DATA 2025</title>
  <style>
    body {
      margin: 0;
      font-family: Arial, sans-serif;
      background: #1e1e1e;
      color: #fff;
    }
    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: #111;
      padding: 10px 20px;
      font-size: 1.2em;
    }
    main {
      padding: 20px;
    }
    .table-block {
      background: #fff;
      color: #000;
      margin-bottom: 30px;
      padding: 10px;
      border-radius: 4px;
      overflow-x: auto;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      margin-bottom: 0;
    }
    th, td {
      border: 1px solid #ccc;
      padding: 6px 8px;
      text-align: center;
    }
    th {
      background-color: #eee;
      font-weight: bold;
    }
    .section-title {
      font-weight: bold;
      font-size: 1.1em;
      margin-bottom: 5px;
    }
  </style>
</head>
<body>
  <header>
    <div>LCDR LIVE DATA 2025</div>
    <div id="date"></div>
  </header>
  <main id="tables-container">Ładowanie danych...</main>

  <script>
    document.getElementById('date').textContent = new Date().toLocaleDateString('pl-PL');

    const sheetId = "10W03bvKlVFlIUcxsHkzP_v_13gtnYRBmnrrO0ujB1bU";
    const sheetName = "live data";
    const url = `https://docs.google.com/spreadsheets/d/${sheetId}/gviz/tq?sheet=${sheetName}`;

    fetch(url)
      .then(res => res.text())
      .then(rep => {
        try {
          const data = JSON.parse(rep.match(/google.visualization.Query.setResponse\(([\s\S\w]+)\)/)[1]);

          if (!data.table || !data.table.rows) {
            console.error("Nie znaleziono odpowiednich danych w odpowiedzi.");
            document.getElementById("tables-container").textContent = "Nie udało się załadować danych.";
            return;
          }

          const rows = data.table.rows;
          const tablesContainer = document.getElementById("tables-container");
          tablesContainer.innerHTML = '';

          let currentSection = null;
          let currentData = [];

          const flushTable = () => {
            if (!currentSection || currentData.length === 0) return;

            const categories = ["NDF", "OK", "SCRAP TTL", "WAITING"];
            const tableData = {
              name: [],
              ndf: [],
              ok: [],
              scrap: [],
              waiting: [],
              total: []
            };

            currentData.forEach(row => {
              const name = row[1]?.v || "";
              const data = {
                NDF: 0,
                OK: 0,
                "SCRAP TTL": 0,
                WAITING: 0
              };

              // Заполнение данных для каждой категории
              for (let i = 2; i < row.length; i++) {
                const category = data.table.cols[i]?.label;
                if (categories.includes(category)) {
                  data[category] = row[i]?.v || 0;
                }
              }

              tableData.name.push(name);
              tableData.ndf.push(data["NDF"]);
              tableData.ok.push(data["OK"]);
              tableData.scrap.push(data["SCRAP TTL"]);
              tableData.waiting.push(data["WAITING"]);
              tableData.total.push(
                data["NDF"] + data["OK"] + data["SCRAP TTL"] + data["WAITING"]
              );
            });

            const div = document.createElement('div');
            div.className = "table-block";

            let html = `<div class="section-title">${currentSection}</div><table><thead><tr>
              <th>Name</th><th>NDF</th><th>OK</th><th>SCRAP TTL</th><th>WAITING</th><th>Suma całkowita</th>
            </tr></thead><tbody>`;

            for (let i = 0; i < tableData.name.length; i++) {
              html += `<tr>
                <td>${tableData.name[i]}</td>
                <td>${tableData.ndf[i]}</td>
                <td>${tableData.ok[i]}</td>
                <td>${tableData.scrap[i]}</td>
                <td>${tableData.waiting[i]}</td>
                <td>${tableData.total[i]}</td>
              </tr>`;
            }

            html += `</tbody></table></div>`;
            div.innerHTML = html;
            tablesContainer.appendChild(div);
          };

          rows.forEach(r => {
            const val = r.c[1]?.v;
            if (typeof val === "string" && val.startsWith("FI #")) {
              flushTable();
              currentSection = val;
              currentData = [];
            } else if (val === "Suma całkowita") {
              currentData.push(r.c);
              flushTable();
              currentData = [];
            } else if (val && val !== "Name") {
              currentData.push(r.c);
            }
          });
        } catch (error) {
          console.error("Błąd podczas przetwarzania danych:", error);
          document.getElementById("tables-container").textContent = "Wystąpił błąd podczas przetwarzania danych.";
        }
      })
      .catch(err => {
        console.error("Błąd ładowania danych:", err);
        document.getElementById("tables-container").textContent = "Nie udało się załadować danych.";
      });
  </script>
</body>
</html>