<!DOCTYPE html>
<html lang="pl">
<head>
  <meta charset="UTF-8">
  <title>Dane z FI Station</title>
  <style>
    body { font-family: sans-serif; padding: 20px; background-color: #f9f9f9; }
    h2 { margin-top: 40px; }
    table { border-collapse: collapse; width: 100%; margin-top: 10px; }
    th, td { border: 1px solid #ccc; padding: 8px; text-align: left; }
    th { background-color: #eee; }
    th, td { width: 14%; } /* Выравнивание столбцов */
  </style>
</head>
<body>
  <h1>Dane z FI Station — dzisiaj</h1>

  <div id="kovzlchyk">
    <h2>fi station kovzlchyk y.</h2>
    <table>
      <thead>
        <tr>
          <th>NAME</th>
          <th>NDF</th>
          <th>OK</th>
          <th>WAITING</th>
          <th>SCRAP TTL</th>
          <th>SCRAP PNLA</th>
          <th>SUMA CALKOWITA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <div id="ulanovych">
    <h2>fi station ulanovych.r</h2>
    <table>
      <thead>
        <tr>
          <th>NAME</th>
          <th>NDF</th>
          <th>OK</th>
          <th>WAITING</th>
          <th>SCRAP TTL</th>
          <th>SCRAP PNLA</th>
          <th>SUMA CALKOWITA</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>

  <script>
    const sheetID = '16MNddQGaidy__FBtRFeiw6HxRDQojBW2_c8Qznt62O8';
    const sheets = [
      { id: 'kovzlchyk', name: 'fi station kovzlchyk y.' },
      { id: 'ulanovych', name: 'fi station ulanovych.r' }
    ];

    const today = new Date();
    today.setHours(0, 0, 0, 0);

    function parseDate(dateStr) {
      const parts = dateStr.split(/[./-]/);
      if (parts.length === 3) {
        const [day, month, year] = parts.map(p => parseInt(p, 10));
        return new Date(year < 100 ? 2000 + year : year, month - 1, day);
      }
      return null;
    }

    function fetchSheet(sheet) {
      const url = `https://docs.google.com/spreadsheets/d/${sheetID}/gviz/tq?sheet=${encodeURIComponent(sheet.name)}`;
      fetch(url)
        .then(res => res.text())
        .then(text => {
          const json = JSON.parse(text.substring(47).slice(0, -2));
          const cols = json.table.cols.map(c => c.label);
          const rows = json.table.rows;

          const container = document.getElementById(sheet.id);
          const tbody = container.querySelector('tbody');
          const statusCount = {};

          // Подсчитываем количество каждого статуса для каждой фамилии
          rows.forEach(row => {
            const cells = row.c.map(cell => (cell ? cell.v : ''));
            const cellDate = parseDate(cells[0]?.toString());
            const name = cells[5]; // Фамилия в колонке F
            const status = cells[4]; // Статус в колонке E
            
            if (cellDate && cellDate.getTime() === today.getTime()) {
              // Инициализация статистики для фамилии
              if (!statusCount[name]) {
                statusCount[name] = {
                  NDF: 0,
                  OK: 0,
                  WAITING: 0,
                  'SCRAP TTL': 0,
                  'SCRAP PNLA': 0,
                  'SUMA CALKOWITA': 0
                };
              }

              // Увеличиваем счетчик для соответствующего статуса
              if (statusCount[name][status] !== undefined) {
                statusCount[name][status]++;
              }
            }
          });

          // Заполняем таблицу
          Object.keys(statusCount).forEach(name => {
            const tr = document.createElement('tr');
            const data = statusCount[name];

            tr.innerHTML = `
              <td>${name}</td>
              <td>${data.NDF}</td>
              <td>${data.OK}</td>
              <td>${data.WAITING}</td>
              <td>${data['SCRAP TTL']}</td>
              <td>${data['SCRAP PNLA']}</td>
              <td>${Object.values(data).reduce((a, b) => a + b, 0)}</td> <!-- Общая сумма -->
            `;
            tbody.appendChild(tr);
          });
        });
    }

    sheets.forEach(fetchSheet);
  </script>
</body>
</html>
